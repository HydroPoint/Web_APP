<!DOCTYPE html>
<html lang="es" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generación de Reportes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Librería para Gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Librería para exportar a PDF (Ejemplo) -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script> -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script> -->

    <!-- Google Maps API (REEMPLAZA "TU_API_KEY_VA_AQUI" con tu clave) -->
    <script src="https://maps.googleapis.com/maps/api/js?key=TU_API_KEY_VA_AQUI&callback=initMap" defer></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* bg-gray-100 */
        }
        
        input:disabled, textarea:disabled, select:disabled {
            background-color: #e5e7eb; /* bg-gray-200 */
            cursor: not-allowed;
            opacity: 0.7;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #00008B; 
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Estilos de Pestañas */
        .tab-button {
            transition: all 0.2s ease;
            border-bottom: 4px solid transparent;
            padding: 0.75rem 1rem; 
            font-weight: 600;
            color: #6b7280; /* text-gray-500 */
            cursor: pointer;
        }
        .tab-button:hover {
            color: #374151; /* text-gray-700 */
            background-color: #f9fafb; /* bg-gray-50 */
        }
        .tab-button.active {
            border-color: #00008B; /* Nuestro azul principal */
            color: #00008B;
        }
        .tab-panel {
            display: none;
        }
        .tab-panel.active {
            display: block;
        }
        
        /* Estilos para la tabla de resultados del reporte */
        #report-content table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        #report-content th,
        #report-content td {
            border: 1px solid #e5e7eb; /* bg-gray-200 */
            padding: 0.75rem 1rem;
            text-align: left;
        }
        #report-content th {
            background-color: #f9fafb; /* bg-gray-50 */
            font-weight: 600;
        }
        #report-content tr:nth-child(even) {
            background-color: #f9fafb; /* bg-gray-50 */
        }
        #report-content .total-row td {
            font-weight: 700;
            background-color: #f3f4f6; /* bg-gray-100 */
        }
        
        /* Estilo para el placeholder del mapa */
        #map-placeholder {
            background-color: #e5e7eb;
            height: 400px;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: #6b7280;
            font-weight: 500;
            border: 2px dashed #9ca3af;
        }
    </style>
</head>
<body class="bg-blue-600">

    <div class="w-full max-w-7xl mx-auto p-6">
        
        <!-- ===== HEADER (Tomado de ADMIN.html) ===== -->
        <div class="w-full flex justify-between items-center pt-8 pb-10">
            <!-- Logo Interactivo -->
            <img data-src-key="logo" alt="Logo" 
                 class="h-10 w-auto cursor-pointer transition-all duration-300 ease-in-out hover:scale-110 active:scale-95 hover:drop-shadow-lg" 
                 onclick="handleNavigation('INDEX')">
            
            <!-- Título actualizado -->
            <h1 id="header-title" class="text-3xl font-bold text-white hidden md:block">Dashboard Financiero</h1>
            
            <!-- Botón de Volver (Tomado de ADMIN.html) -->
            <button
              id="btn-back-to-search" 
              onclick="handleNavigation('INDEX')"
              type="button"
              class="bg-white text-center w-48 rounded-2xl h-14 relative text-blue-700 text-xl font-semibold border-4 border-white group"
            >
              <div
                class="bg-blue-600 rounded-xl h-12 w-1/4 grid place-items-center absolute left-0 top-0 group-hover:w-full z-10 duration-500"
              >
                <svg
                  class="w-6 h-6"
                  viewBox="0 0 1024 1024"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    fill="#FFFFFF" 
                    d="M224 480h640a32 32 0 1 1 0 64H224a32 32 0 0 1 0-64z"
                  ></path>
                  <path
                    fill="#FFFFFF"
                    d="m237.248 512 265.408 265.344a32 32 0 0 1-45.312 45.312l-288-288a32 32 0 0 1 0-45.312l288-288a32 32 0 1 1 45.312 45.312L237.248 512z"
                  ></path>
                </svg>
              </div>
              <p class="translate-x-4 transition-transform duration-500 group-hover:translate-x-0">Volver</p> 
            </button>
        </div>
        
        <!-- ===== CONTENEDOR PRINCIPAL CON PESTAÑAS ===== -->
        <div class="bg-white rounded-lg shadow-md p-6">
            
            <!-- Navegación de Pestañas -->
            <div class="border-b border-gray-200 mb-6">
                <nav class="flex -mb-px space-x-4" aria-label="Tabs">
                    <button class="tab-button active" data-tab="reportes">Reportes</button>
                    <button class="tab-button" data-tab="proyecciones">Proyecciones</button>
                    <button class="tab-button" data-tab="valoracion">Valoración</button>
                </nav>
            </div>

            <!-- ===== Pestaña 1: REPORTES ===== -->
            <div id="tab-reportes" class="tab-panel active">
                
                <h2 class="text-xl font-bold text-gray-800 mb-6">Generar Reportes Contables (FMS)</h2>

                <!-- Formulario de Selección de Fechas y Botones -->
                <form id="report-form">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        
                        <!-- Selector Desde -->
                        <div>
                            <label for="date-from" class="block text-sm font-medium text-gray-700">Desde</label>
                            <input type="date" id="date-from" name="date-from"
                                   class="w-full mt-1 px-4 py-3 rounded-lg bg-gray-100 border-transparent focus:border-blue-500 focus:bg-white focus:ring-0">
                        </div>
                        
                        <!-- Selector Hasta -->
                        <div>
                            <label for="date-to" class="block text-sm font-medium text-gray-700">Hasta</label>
                            <input type="date" id="date-to" name="date-to"
                                   class="w-full mt-1 px-4 py-3 rounded-lg bg-gray-100 border-transparent focus:border-blue-500 focus:bg-white focus:ring-0">
                        </div>

                        <!-- Botón P&G -->
                        <div>
                            <button type="button" id="btn-generate-pg"
                                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300 flex items-center justify-center">
                                <span class="btn-text">Generar P&G</span>
                                <div class="spinner btn-spinner hidden"></div>
                            </button>
                        </div>

                        <!-- Botón Balance -->
                        <div>
                            <button type="button" id="btn-generate-balance"
                                    class="w-full bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300 flex items-center justify-center">
                                <span class="btn-text">Generar Balance</span>
                                <div class="spinner btn-spinner hidden"></div>
                            </button>
                        </div>

                    </div>
                </form>

                <!-- Área de Estado (Spinner/Mensajes) -->
                <div id="report-status-container" class="text-center py-8">
                    <div id="report-loading-spinner" class="spinner mx-auto hidden" style="width: 48px; height: 48px;"></div>
                    <p id="report-message" class="text-sm h-5 text-gray-500">Seleccione un rango de fechas y genere un reporte.</p>
                </div>

                <!-- ===== NUEVO: Dashboard Visual (Gráficos y Gauges) ===== -->
                <div id="visual-dashboard" class="hidden mt-8 space-y-8">
                    
                    <!-- Sección de Gauges y Gráficos -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Gauge 1 -->
                        <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                            <h4 class="text-center font-semibold text-gray-700 mb-2">Margen de Utilidad</h4>
                            <div class="relative w-full" style="max-height: 250px;">
                                <canvas id="gauge-chart-1"></canvas>
                                <div id="gauge-label-1" class="absolute inset-0 flex items-center justify-center text-3xl font-bold text-gray-800"></div>
                            </div>
                        </div>
                        <!-- Gauge 2 -->
                        <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                            <h4 class="text-center font-semibold text-gray-700 mb-2">Nivel de Gastos</h4>
                            <div class="relative w-full" style="max-height: 250px;">
                                <canvas id="gauge-chart-2"></canvas>
                                <div id="gauge-label-2" class="absolute inset-0 flex items-center justify-center text-3xl font-bold text-gray-800"></div>
                            </div>
                        </div>
                        <!-- Gráfico de Barras -->
                        <div class="bg-gray-50 p-4 rounded-lg shadow-inner md:col-span-1">
                             <h4 class="text-center font-semibold text-gray-700 mb-2">Ingresos vs Gastos</h4>
                            <div class="relative w-full" style="max-height: 250px;">
                                <canvas id="bar-chart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Sección de Mapa -->
                    <div>
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Geolocalización de Clientes</h3>
                        <div id="map-placeholder">
                            <div>
                                <p class="text-lg">Cargando mapa...</p>
                                <p class="text-sm">(Si el mapa no carga, verifica la API Key de Google Maps en el &lt;head&gt;)</p>
                            </div>
                        </div>
                        <!-- 
                        Comentario para implementación de Google Maps:
                        1. Obtener una API Key de Google Maps Platform.
                        2. Añadir el script en el <head>: 
                           <script src="https://maps.googleapis.com/maps/api/js?key=TU_API_KEY&callback=initMap" defer></script>
                        3. Crear una función global `initMap()` en el script principal. (¡Hecho!)
                        4. En `initMap()`, instanciar el mapa:
                           map = new google.maps.Map(document.getElementById("map-placeholder"), { center: {lat: 4.6, lng: -74.0}, zoom: 5 }); (¡Hecho!)
                        5. Al recibir los datos del reporte, obtener las ubicaciones y añadir marcadores:
                           Se agregó la función updateMap() que se llama en onReportSuccess (¡Hecho!)
                        -->
                    </div>

                </div>

                <!-- ===== Área de Resultados (Tabla) ===== -->
                <div id="report-results-container" class="mt-6 border-t pt-6 hidden">
                    
                    <!-- NUEVO: Opciones de Exportación -->
                    <div class="flex justify-between items-center mb-4">
                        <h3 id="report-title" class="text-2xl font-semibold text-gray-800"></h3>
                        <div id="export-options" class="relative">
                            <button id="export-toggle" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 flex items-center">
                                Exportar
                                <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </button>
                            <!-- Menú Dropdown -->
                            <div id="export-menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-20 border">
                                <a href="#" onclick="exportToCSV()" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Exportar a CSV</a>
                                <a href="#" onclick="exportToPDF()" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Exportar a PDF</a>
                                <a href="#" onclick="openLookerStudio()" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Ver en Looker Studio</a>
                            </div>
                        </div>
                    </div>

                    <!-- El contenido (ej. una tabla) se inyectará aquí -->
                    <div id="report-content" class="overflow-x-auto">
                        <!-- La tabla generada por CODE.gs irá aquí -->
                    </div>
                </div>

            </div> <!-- Fin Pestaña Reportes -->

            <!-- ===== Pestaña 2: PROYECCIONES ===== -->
            <div id="tab-proyecciones" class="tab-panel">
                <h2 class="text-xl font-bold text-gray-800 mb-6">Proyecciones Financieras</h2>
                <div class="bg-gray-50 p-6 rounded-lg shadow-inner">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Proyección de Flujo de Caja (Próximos 12 meses)</h3>
                    <div class="relative w-full" style="height: 400px;">
                        <canvas id="projection-chart"></canvas>
                    </div>
                    <p class="text-center text-gray-500 mt-4">
                        Módulo de proyecciones para análisis de escenarios futuros.
                    </p>
                </div>
            </div>

            <!-- ===== Pestaña 3: VALORACIÓN ===== -->
            <div id="tab-valoracion" class="tab-panel">
                <h2 class="text-xl font-bold text-gray-800 mb-6">Valoración de la Empresa</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Métrica 1 -->
                    <div class="bg-blue-50 p-6 rounded-lg shadow-inner border border-blue-200">
                        <h4 class="text-sm font-medium text-blue-800 uppercase">VAN (Valor Actual Neto)</h4>
                        <p class="text-3xl font-bold text-blue-900 mt-2">$ 1,250,000</p>
                        <p class="text-sm text-blue-700 mt-1">+15% vs Proyectado</p>
                    </div>
                    <!-- Métrica 2 -->
                    <div class="bg-green-50 p-6 rounded-lg shadow-inner border border-green-200">
                        <h4 class="text-sm font-medium text-green-800 uppercase">TIR (Tasa Interna de Retorno)</h4>
                        <p class="text-3xl font-bold text-green-900 mt-2">18.5%</p>
                        <p class="text-sm text-green-700 mt-1">Supera la tasa de oportunidad (12%)</p>
                    </div>
                    <!-- Métrica 3 -->
                    <div class="bg-yellow-50 p-6 rounded-lg shadow-inner border border-yellow-200">
                        <h4 class="text-sm font-medium text-yellow-800 uppercase">Ratio de Endeudamiento</h4>
                        <p class="text-3xl font-bold text-yellow-900 mt-2">0.45</p>
                        <p class="text-sm text-yellow-700 mt-1">Nivel de apalancamiento saludable</p>
                    </div>
                </div>
                 <p class="text-center text-gray-500 mt-6">
                    Módulo de valoración con métodos de flujo de caja descontado y múltiplos.
                </p>
            </div>

        </div> <!-- Fin del contenedor de pestañas -->

    </div>
    
<script>
    const SCRIPT_URL = '<?= url ?>';

    // ==================================================================
    // LISTADO CENTRAL DE IMÁGENES
    // ==================================================================
    const imageConfig = {
        logo: "https://i.postimg.cc/BQ2Sp0T4/Logotransparente.png"
    };

    function populateImages() {
        const images = document.querySelectorAll('[data-src-key]');
        images.forEach(img => {
            const key = img.getAttribute('data-src-key');
            if (imageConfig[key]) {
                img.src = imageConfig[key];
            }
        });
    }
    // ==================================================================

    // Estado de la UI
    let isLoading = false;
    
    // --- REFERENCIAS AL DOM ---
    const dateFrom = document.getElementById('date-from');
    const dateTo = document.getElementById('date-to');
    const btnGeneratePg = document.getElementById('btn-generate-pg');
    const btnGenerateBalance = document.getElementById('btn-generate-balance');
    
    const reportStatusContainer = document.getElementById('report-status-container');
    const reportLoadingSpinner = document.getElementById('report-loading-spinner');
    const reportMessage = document.getElementById('report-message');
    
    // Contenedores de resultados
    const reportResultsContainer = document.getElementById('report-results-container');
    const reportTitle = document.getElementById('report-title');
    const reportContent = document.getElementById('report-content');

    // Nuevos elementos
    const visualDashboard = document.getElementById('visual-dashboard');
    const exportToggle = document.getElementById('export-toggle');
    const exportMenu = document.getElementById('export-menu');

    // Referencias a los charts (se inicializarán luego)
    let chartGauge1 = null;
    let chartGauge2 = null;
    let chartBar = null;
    let chartProjection = null;

    // Nuevas variables globales para el Mapa
    let map;
    let mapMarkers = [];

    /**
     * Inicializa los campos de fecha
     */
    function initializeDates() {
        const today = new Date();
        const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
        
        const todayStr = today.toISOString().split('T')[0];
        const firstDayStr = firstDayOfMonth.toISOString().split('T')[0];
        
        dateTo.value = todayStr;
        dateFrom.value = firstDayStr;
    }

    /**
     * Maneja la solicitud de generación de reporte
     */
    function handleGenerateReport(reportType) {
        if (isLoading) return;

        const from = dateFrom.value;
        const to = dateTo.value;

        if (!from || !to) {
            showMessage('Debe seleccionar un rango de fechas.', 'red');
            return;
        }

        let button;
        let functionToCall;

        if (reportType === 'pg') {
            button = btnGeneratePg;
            functionToCall = 'getProfitAndLoss'; 
        } else {
            button = btnGenerateBalance;
            functionToCall = 'getBalanceSheet'; 
        }

        setLoading(true, button);
        
        // Ocultar resultados anteriores (incluyendo gráficos y export)
        reportResultsContainer.classList.add('hidden');
        visualDashboard.classList.add('hidden');
        reportTitle.innerHTML = '';
        reportContent.innerHTML = '';
        updateMap([]); // Limpiar el mapa al iniciar una nueva solicitud

        const payload = { dateFrom: from, dateTo: to };

        google.script.run
            .withSuccessHandler(response => onReportSuccess(response, button))
            .withFailureHandler(error => onReportFailure(error, button))
            [functionToCall](payload);
    }

    /**
     * Callback éxitoso al recibir datos del reporte
     */
    function onReportSuccess(response, button) {
        setLoading(false, button);

        if (response && response.success) {
            reportTitle.textContent = response.title || 'Reporte Generado';
            reportContent.innerHTML = response.html || '<p>No se generaron datos para este rango.</p>';
            
            // Mostrar los contenedores de resultados y gráficos
            reportResultsContainer.classList.remove('hidden');
            visualDashboard.classList.remove('hidden');
            
            showMessage('Reporte generado exitosamente.', 'green');

            // Renderizar los gráficos (con datos reales o vacíos)
            renderCharts(response.chartData || getEmptyChartData());

            // Actualizar el mapa (con datos reales o un array vacío)
            // El backend debe proveer 'response.mapData'
            // Ejemplo de mapData: [{lat: 4.6, lng: -74.0, title: "Cliente 1"}, {lat: 1.2, lng: -77.2, title: "Cliente 2"}]
            updateMap(response.mapData || []);

        } else {
            const errorMsg = response.error || 'Respuesta inválida del servidor.';
            onReportFailure(new Error(errorMsg), button);
        }
    }

    /**
     * Callback de fallo
     */
    function onReportFailure(error, button) {
        setLoading(false, button);
        showMessage(error.message, 'red');
        reportResultsContainer.classList.add('hidden');
        visualDashboard.classList.add('hidden'); // Ocultar gráficos en caso de error
        updateMap([]); // Limpiar el mapa en caso de error
    }

    /**
     * Controla el estado visual de carga
     */
    function setLoading(isLoadingState, button = null) {
        isLoading = isLoadingState;
        reportLoadingSpinner.classList.toggle('hidden', !isLoadingState);
        
        btnGeneratePg.disabled = isLoadingState;
        btnGenerateBalance.disabled = isLoadingState;
        
        if (button) {
            const btnText = button.querySelector('.btn-text');
            const btnSpinner = button.querySelector('.btn-spinner');
            
            if (isLoadingState) {
                btnText.classList.add('hidden');
                btnSpinner.classList.remove('hidden');
            } else {
                btnText.classList.remove('hidden');
                btnSpinner.classList.add('hidden');
            }
        }
        
        if (!isLoadingState) {
            reportMessage.textContent = 'Seleccione un rango de fechas y genere un reporte.';
            reportMessage.className = 'text-sm h-5 text-gray-500';
            
            document.querySelectorAll('.btn-text').forEach(el => el.classList.remove('hidden'));
            document.querySelectorAll('.btn-spinner').forEach(el => el.classList.add('hidden'));
        } else {
            showMessage('Generando reporte, por favor espere...', 'default');
        }
    }

    // ==================================================================
    // LÓGICA DE PESTAÑAS
    // ==================================================================
    function setupTabs() {
        const tabContainer = document.querySelector(".bg-white.rounded-lg");
        
        tabContainer.addEventListener("click", (e) => {
            const tabButton = e.target.closest(".tab-button");
            if (!tabButton) return;

            const tabId = tabButton.dataset.tab;
            if (!tabId) return;

            // Ocultar todos los paneles
            tabContainer.querySelectorAll(".tab-panel").forEach(panel => {
                panel.classList.remove("active");
            });
            // Quitar 'active' a todos los botones
            tabContainer.querySelectorAll(".tab-button").forEach(button => {
                button.classList.remove("active");
            });

            // Mostrar el panel seleccionado
            const activePanel = tabContainer.querySelector(`#tab-${tabId}`);
            if (activePanel) {
                activePanel.classList.add("active");
            }
            // Marcar el botón como activo
            tabButton.classList.add("active");
            
            // Renderizar gráficos de pestañas (si es necesario y no están renderizados)
            if (tabId === 'proyecciones' && !chartProjection) {
                renderProjectionChart();
            }
        });
    }

    // ==================================================================
    // LÓGICA DE GRÁFICOS (con Chart.js)
    // ==================================================================
    
    /** Devuelve datos de ejemplo (ya no se usa por defecto en onReportSuccess) */
    function getMockChartData() {
        // Datos de ejemplo
        return {
            gauge1: { value: 35, max: 100 }, // Margen 35%
            gauge2: { value: 80, max: 100 }, // Gastos 80% del presupuesto
            bar: {
                ingresos: 120000,
                gastos: 85000
            }
        };
    }

    /** Devuelve datos vacíos para los gráficos */
    function getEmptyChartData() {
        return {
            gauge1: { value: 0, max: 100 },
            gauge2: { value: 0, max: 100 },
            bar: {
                ingresos: 0,
                gastos: 0
            }
        };
    }

    function renderCharts(data) {
        // --- Gauge 1: Margen de Utilidad ---
        const gaugeValue1 = data.gauge1.value;
        document.getElementById('gauge-label-1').textContent = `${gaugeValue1}%`;
        
        if (chartGauge1) chartGauge1.destroy();
        chartGauge1 = renderGauge('gauge-chart-1', gaugeValue1, ['#00008B', '#e5e7eb']);
        
        // --- Gauge 2: Nivel de Gastos ---
        const gaugeValue2 = data.gauge2.value;
         document.getElementById('gauge-label-2').textContent = `${gaugeValue2}%`;

        if (chartGauge2) chartGauge2.destroy();
        chartGauge2 = renderGauge('gauge-chart-2', gaugeValue2, ['#D9534F', '#e5e7eb']);

        // --- Bar Chart: Ingresos vs Gastos ---
        const ctxBar = document.getElementById('bar-chart').getContext('2d');
        if (chartBar) chartBar.destroy();
        chartBar = new Chart(ctxBar, {
            type: 'bar',
            data: {
                labels: ['Resumen'],
                datasets: [
                    {
                        label: 'Ingresos',
                        data: [data.bar.ingresos],
                        backgroundColor: '#4CAF50',
                        borderRadius: 4,
                    },
                    {
                        label: 'Gastos',
                        data: [data.bar.gastos],
                        backgroundColor: '#D9534F',
                        borderRadius: 4,
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: { mode: 'index', intersect: false }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }
    
    /** Helper para crear un gauge (gráfico de dona) */
    function renderGauge(canvasId, value, colors) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        const data = {
            datasets: [{
                data: [value, 100 - value],
                backgroundColor: colors,
                borderColor: 'transparent',
                borderWidth: 0,
                circumference: 180, // Media dona
                rotation: 270,      // Empezar desde abajo
            }]
        };
        return new Chart(ctx, {
            type: 'doughnut',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 2, // Ajustar para que quepa la media dona
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false }
                },
                cutout: '80%' // Grosor del gauge
            }
        });
    }
    
    /** Gráfico para la pestaña de Proyecciones */
    function renderProjectionChart() {
        const ctx = document.getElementById('projection-chart').getContext('2d');
        if (chartProjection) chartProjection.destroy();
        chartProjection = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
                datasets: [{
                    label: 'Flujo de Caja Proyectado',
                    data: [50, 55, 60, 70, 80, 75, 85, 90, 100, 110, 120, 130], // Datos de ejemplo
                    borderColor: '#00008B',
                    backgroundColor: 'rgba(0, 0, 139, 0.1)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { 
                        beginAtZero: true,
                        ticks: { callback: (value) => `$${value}k` } 
                    }
                }
            }
        });
    }


    // ==================================================================
    // LÓGICA DE GOOGLE MAPS
    // ==================================================================

    /**
     * Función de callback para la API de Google Maps.
     * Se llama automáticamente cuando el script de la API se carga.
     */
    function initMap() {
        console.log("Google Maps API inicializada.");
        const bogota = { lat: 4.60971, lng: -74.08175 };
        
        try {
             map = new google.maps.Map(document.getElementById("map-placeholder"), {
                center: bogota,
                zoom: 5,
            });
            
            // Ocultar el texto de "Cargando mapa..."
            const mapPlaceholderContent = document.querySelector("#map-placeholder > div");
            if (mapPlaceholderContent) {
                mapPlaceholderContent.style.display = 'none'; 
            }
        } catch (e) {
            console.error("Error al inicializar Google Maps:", e);
            const mapPlaceholderContent = document.querySelector("#map-placeholder > div");
            if (mapPlaceholderContent) {
                mapPlaceholderContent.innerHTML = '<p class="text-red-500 font-bold">Error al cargar el mapa. Verifica la API Key.</p>';
            }
        }
    }

    /**
     * Actualiza el mapa con nuevas ubicaciones.
     * @param {Array} locations - Un array de objetos {lat, lng, title}
     */
    function updateMap(locations = []) {
        // 1. Limpiar marcadores anteriores
        mapMarkers.forEach(marker => marker.setMap(null));
        mapMarkers = [];

        if (typeof google === 'undefined' || !google.maps || !map) {
            console.warn("El mapa no está listo o Google Maps no se cargó.");
            return;
        }

        if (locations.length === 0) {
            // Si no hay ubicaciones, centrar en la vista por defecto
            map.setCenter({ lat: 4.60971, lng: -74.08175 });
            map.setZoom(5);
            return;
        }

        const bounds = new google.maps.LatLngBounds();
        
        // 2. Añadir nuevos marcadores
        locations.forEach(loc => {
            if (loc.lat != null && loc.lng != null) {
                const position = { lat: loc.lat, lng: loc.lng };
                const marker = new google.maps.Marker({
                    position: position,
                    map: map,
                    title: loc.title || 'Cliente'
                });
                mapMarkers.push(marker);
                bounds.extend(position);
            }
        });

        // 3. Ajustar el zoom del mapa a los marcadores
        if (mapMarkers.length > 0) {
            map.fitBounds(bounds);
        }
        
        // Evitar zoom excesivo si solo hay un marcador
        if (mapMarkers.length === 1) {
            map.setZoom(10);
        }
    }


    // ==================================================================
    // LÓGICA DE EXPORTACIÓN
    // ==================================================================
    
    function setupExportMenu() {
        exportToggle.addEventListener('click', () => {
            exportMenu.classList.toggle('hidden');
        });
        
        // Ocultar menú si se hace clic fuera
        document.addEventListener('click', (e) => {
            if (!exportToggle.contains(e.target) && !exportMenu.contains(e.target)) {
                exportMenu.classList.add('hidden');
            }
        });
    }

    function exportToCSV() {
        console.log("Exportando a CSV...");
        const table = reportContent.querySelector('table');
        if (!table) {
            alert("No hay tabla para exportar.");
            return;
        }

        let csv = [];
        // Encabezados
        let headers = [];
        table.querySelectorAll('thead th').forEach(th => headers.push(`"${th.textContent.trim()}"`));
        csv.push(headers.join(','));

        // Filas
        table.querySelectorAll('tbody tr').forEach(row => {
            let rowData = [];
            row.querySelectorAll('td').forEach(td => rowData.push(`"${td.textContent.trim()}"`));
            csv.push(rowData.join(','));
        });

        // Descarga
        const csvContent = "data:text/csv;charset=utf-8," + csv.join("\n");
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `reporte_${dateFrom.value}_a_${dateTo.value}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        exportMenu.classList.add('hidden');
    }

    function exportToPDF() {
        alert("La exportación a PDF requiere una librería externa como jsPDF.\n(Esta función es un placeholder).");
        // --- Ejemplo con jsPDF (requiere incluir los scripts comentados en el <head>) ---
        /*
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.autoTable({ html: '#report-content table' });
            doc.save(`reporte_${dateFrom.value}_a_${dateTo.value}.pdf`);
        } catch(e) {
            console.error("Error al exportar a PDF. Asegúrate de que jsPDF y jsPDF-AutoTable estén cargados.", e);
            alert("Error al inicializar jsPDF. Revisa la consola.");
        }
        */
        exportMenu.classList.add('hidden');
    }

    function openLookerStudio() {
        alert("Redirigiendo al dashboard de Looker Studio.\n(Esta función es un placeholder).");
        const lookerStudioUrl = "https://lookerstudio.google.com/u/0/"; // Reemplazar con URL real
        window.open(lookerStudioUrl, '_blank');
        exportMenu.classList.add('hidden');
    }

    // ==================================================================
    // FUNCIONES UTILITARIAS
    // ==================================================================

    function showMessage(message, color) {
        const el = reportMessage;
        el.textContent = message;
        
        if (color === 'red') {
            el.className = 'text-sm h-5 text-red-500';
        } else if (color === 'green') {
            el.className = 'text-sm h-5 text-green-600';
        } else {
            el.className = 'text-sm h-5 text-gray-500';
        }
    }
    
    // --- NAVEGACIÓN DEL DASHBOARD ---
    function handleNavigation(pageId) {
        console.log('Navegar a:', pageId);
        window.top.location.href = SCRIPT_URL + "?page=" + pageId;
    }

    /**
     * Función robusta para esperar a que google.script.run esté listo.
     */
    function onGoogleScriptReady(callback) {
        if (typeof google !== 'undefined' && google.script && google.script.run) {
            callback();
        } else {
            setTimeout(() => onGoogleScriptReady(callback), 50);
        }
    }

    // --- INICIALIZACIÓN ---
    window.onload = function() {
        populateImages(); 
        setupTabs();
        setupExportMenu();
        
        // Añadir listeners a los botones de reporte
        btnGeneratePg.addEventListener('click', () => handleGenerateReport('pg'));
        btnGenerateBalance.addEventListener('click', () => handleGenerateReport('balance'));

        onGoogleScriptReady(initializeDates);
    };
</script>

</body>
</html>